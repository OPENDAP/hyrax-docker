
# Initial Travic-CI control file. 6.11.15 jhrg
# Added sonar scan 3.12.19 jhrg 

dist: trusty

language: python

python:
  - 3.4

services:
  - docker

branches:
  only:
    - master
    - travis

notifications:
  email:
    - ndp@opendap.org
    - jgallagher@opendap.org

env:
  global:
    #
    # AWS_ACCESS_KEY_ID for the user 'travis'
    - secure: "QBOT+WjiDl5//jaAvlRaBxpI2lp6jZgh9kksJ+f4PZ6QwvEObh3Ns+ZZdFkDsVMwIiSEMr/UyLx5HiP0mxSFmVDwBsppcsmaaaEuoYpmiUmrvzZN/jW4qJsohyccUwTYaKlahVW+Aro9c5Go6fNs72hxQS6USQAHDqOI0BaSg2NqyqCMeVIidhYKGcdDzgVshRjuvgpXNE4BD/sfZrtvRXYqsXjjED67OL8gYUEMhgHgcKbWj75PVyMaWphlMYRpC0fpW40Tb2LyTMD4ViTinmCF5LSZwQSaXkxKaKMT+JNdigc0jMCtOhUchAtK8ORcAOS+V1lrMWLbPdNxJ8keeq+F34zAUYNWdKRu6BHdyJEX44AuR0wcJIcaX1eGZ+0l92aMDn/IVIJnH86H6ehXXJFd9w6Qr6XVAhSXEHJk/JHatnP5UYzIOOyD/livSFSAnVBOe2hQMDN+5d+eCh4XLTondn+DwLTCxT2C1Pe+4mQ0qbz25DEOw/eSa8cAFLQscwwEabzteZ74tLOQMDRN2RLfXpKvoYuRmbIQAixN3NhysaEzYNuWfSxFWCl4gNo9aUJQu0j8jxg9A9Szb7nQ0dw7OB62qRakSVnzEVNnuwrERuFvBrC7leN0SBoyn8Gcs0opOKMeWiOlaRSA+/Yd3mk8Kaiq9ckuPfoxvpSP/L8="
    #
    # AWS_SECRET_ACCESS_KEY
    - secure: "sNbrNY3veaYPGLrXOMUXxZJbSVtMiaW6nMuWVdoOrXO2PBRbkyoRzX/7jm714429X/mBSLxPWH5dNzs6z1kDi0Tug3bhvD1ErL4ioCrSRUX1Dzl6DF/wkwX3sfm0l0NPq3CX9IUHyslcHhAWLy9zlqsTo2ToydOApGg1Cq/URwxH0tttxuMjDKA5/ybm2UJMQBMm/Ti4fVzeL0H9OsYCFxirC1/37Sl7dC5zCsDCzjjIE4bU7q9oQTt2j4gJqLl6J6ja2T/XSjSyrf5QQ1esAE3GSqa6qW0S3ZkVq1W/968Hnfcv83Y5Oql/aB+s2eRlM4MzpYZxgLDHps47rp9spW67Lum1RW5lPlYN6OcG7BxVzsow85Fwt+RuIlBrQa4GeZ+Ag3g8HKW347AJfKjXjP4RmpnL7ZcMb7sJ2l7TJo5M4v5JefT2P6wUk1OoNXV13z7MKESziNL4qNSMjHCe6cpvXXe593vVRDw9FZql24tLr9rugxIi5Dylw4DmvNNaVYDFbSBpXDMVaAvhIZYA48thIDcQ9az3huVg5x7NLf8GkOe4qV41GZXQEv3uz8KFlY2IB+x6ANoUjMQ123kTHORafcreFkILtSX2id1x5DnpXHPmisT5wUK5hnMJ2K4irR/vJaoqtdc8jeHL/6xO4WVd4ZmqkxcpaI4+0TiCpSg="
    #
    # DOCKER_USERNAME for our DockerHub account
    - secure: "SeClVCFBXKAhynv5wD/6OdqLwtK0d5kc0XawlwinPBT2Hg5Y1ZlQKIAZsOwOqXTUcAQtVjnHYLru09ataLuDRIdtcZeDv7TKkE6ZS9nFb4bMM8j6XwxFo2lM4pICks7tY5clClRTvTzdxbkPbmfxHnInHnZmB8md/gOIi3KJseRVS9aignr+1qxyvuyAPha9Rxeiz+iOo4kWKuK3IGiSKp5qIJczoz631f3lsZQJ14Eyiz8vcCL0mJxQ3RbBfl9pNsYmM9XZSCSp9yRNCCDkLGUZNIRNjamy5UFxkhb2meGWOCTAgD5kvRl5LjIv7i2//r46tBN9OMZ8Agz4FvVM9OzWMGCGoimQ6omTp+/+bn+gBhssVoZi4Z9EgYdl2oWPCk8XihmCpFcY/wWrxuYWjQ9u5eXOEVrLp3qNMhmq1X3Z/RWev40b1hWy5ofqjdKfQHsC6j/HHGzxey+VRR9PZHke9c38uOLqb/4Wkaa5Nm3W4cFaeAzyB26GjTe2FiaKZKmYyHz75G52TEoFAOoe2UShp/JDG/HAefr2XJuA1vxHfn/xURMxvoHJ3XEfOORE1S+mP3iREl3Gl1hlp9Dpa6UTWkO6WWdMkBhhX104zyHtTtJu1EebAgoUzoyTe14gi8OgD6FECGyUK4f4c9PlfKabu0y72Nw29t5ef4OKffc="
    #
    # DOCKER_PASSWORD for our DockerHub account
    - secure: "DvQvxpRtfC/EUZ8LjxjL7XvfRRHmt1eimmSbDCAObedkglvjyI0Cvv0njzHDnPLLLZQ2HgtDAzVwZ4OhcJxw0L2olv8/3n01dTwgisziC/bquQHUJHB735naHJUUHB+Id0+02TB9VSJUSeWmlV6wml1hPgk290sHUNQ3+zLxYz51/F6pw4dC4hNuEji0J8A+wDsx2GUGPZaRqiVqAFjKGcnbRTZF/uZ/NRk5AVsxVW+4CF6Jy/e+9WNkj7XlPtPMSS8HCz+20hbhKRJTqlul2pMQOhqWBClEE39kKEd3Mv5UxeCr6hunAEVyS4ig91XgZykSh4/BZ5Tj9aG7LsA0uE4mAhYmN0NrfG3dtfSFSVPF9LwENk2hrh1HSLjuYF1VZpW+sJqnYZmZ35yBY+WtbUd2IwHZ/eVjKk4JX4O2+W3B62GuldSxwYGpoE0wJjmucGSt2XGo7r1nC1Em1rcA9wbzUPjb4Q6/MVPsrX0o3NKUcCn2FoOCat92Ge7WwnIM7LaHm0/6j2uoXLzPd8VAyxLLq0vhyY/7cxQp+8/+j7fIU4K0yJYNq97OOXlcSdkWhNW3kmnE26mPmWUQht5icz0YFAHielPLn3GarZA2X5bYeZ4ffElaN+QFv/4Jy4qRHS0Caml3el2Xi3jqQcj6DFRVKHNdNyvm0JL7b58xfv0="

install:
  - pip3 install awscli
  # pip3 install --upgrade -r .travis.requirements

stages:
  - name: build
    if:  branch = master

jobs:
  include:
    - stage: build
      script:
        - cd hyrax-snapshot
        - docker build --build-arg RELEASE_DATE=`date +%s` --build-arg AWS_ACCESS_KEY_ID --build-arg AWS_SECRET_ACCESS_KEY -t "opendap/besd:snapshot" besd
        - docker image ls -a
        - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
        - docker push opendap/besd:snapshot
        - aws configure list
        - DOCKER_LOGIN=`aws ecr get-login --region us-east-1 | sed "s/-e none //g"`
        - $DOCKER_LOGIN
        - docker tag opendap/besd:snapshot 747931985039.dkr.ecr.us-east-1.amazonaws.com/opendap/besd:snapshot
        - docker push 747931985039.dkr.ecr.us-east-1.amazonaws.com/opendap/besd:snapshot

    - stage: build
      script:
        - cd hyrax-snapshot
        - docker build --build-arg RELEASE_DATE=`date +%s` --build-arg AWS_ACCESS_KEY_ID --build-arg AWS_SECRET_ACCESS_KEY -t "opendap/olfs:snapshot" olfs
        - docker image ls -a
        - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
        - docker push opendap/olfs:snapshot
        - aws configure list
        - DOCKER_LOGIN=`aws ecr get-login --region us-east-1 | sed "s/-e none //g"`
        - $DOCKER_LOGIN
        - docker tag opendap/olfs:snapshot 747931985039.dkr.ecr.us-east-1.amazonaws.com/opendap/olfs:snapshot
        - docker push 747931985039.dkr.ecr.us-east-1.amazonaws.com/opendap/olfs:snapshot

    - stage: build
      script:
        - cd hyrax-snapshot
        - docker build --build-arg RELEASE_DATE=`date +%s` --build-arg AWS_ACCESS_KEY_ID --build-arg AWS_SECRET_ACCESS_KEY -t "opendap/hyrax:snapshot" hyrax
        - docker image ls -a
        - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
        - docker push opendap/hyrax:snapshot
        - aws configure list
        - DOCKER_LOGIN=`aws ecr get-login --region us-east-1 | sed "s/-e none //g"`
        - $DOCKER_LOGIN
        - docker tag opendap/hyrax:snapshot 747931985039.dkr.ecr.us-east-1.amazonaws.com/opendap/hyrax:snapshot
        - docker push 747931985039.dkr.ecr.us-east-1.amazonaws.com/opendap/hyrax:snapshot

    - stage: build
      script:
        - cd hyrax-snapshot
        - docker build --build-arg RELEASE_DATE=`date +%s` --build-arg AWS_ACCESS_KEY_ID --build-arg AWS_SECRET_ACCESS_KEY -t "opendap/hyrax_ncwms:snapshot" hyrax
        - docker image ls -a
        - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
        - docker push opendap/hyrax_ncwms:snapshot
        - aws configure list
        - DOCKER_LOGIN=`aws ecr get-login --region us-east-1 | sed "s/-e none //g"`
        - $DOCKER_LOGIN
        - docker tag opendap/hyrax_ncwms:snapshot 747931985039.dkr.ecr.us-east-1.amazonaws.com/opendap/hyrax_ncwms:snapshot
        - docker push 747931985039.dkr.ecr.us-east-1.amazonaws.com/opendap/hyrax_ncwms:snapshot
