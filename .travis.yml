
# Initial Travic-CI control file. 6.11.15 jhrg
# Added sonar scan 3.12.19 jhrg 

dist: trusty

# Use the docker container-based build systems
sudo: false

language: java

services:
    - docker
    
# Drop this and use the jdk: ... lines in the jobs: section below.
# jhrg 3/19/19
#
# jdk:
#  - openjdk7
#  - openjdk8

# whitelist
branches:
  only:
    - master

notifications:
  email:
    - ndp@opendap.org
    - jgallagher@opendap.org


env:
  global:
    # AWS_ACCESS_KEY_ID for the user 'travis'
    - secure: "MB2g7wf6e2Dt5so1Ek6zoAP04L/8GjKxbOlHQKgTa+Luw30Oa7ndqrG9gc0FX/K3dr03WOjEnO6lZmL9ZMwK7Q2FadrzYO0Ym8ZkruOFMFZxrpRnUX30yQFz6zgY9zGe0PiCNdO7++wYXOaP5xGi6UVyMsfhfWtY3p5Aq9qyU8c="
    # AWS_SECRET_ACCESS_KEY
    - secure: "aLQeyAMzLydF6mK3Qpy0RewpD3VjzzFbQZhD0m/esLercK4tYHj3F4RlLNqCnKSBnrJcIvvFrEHad15B1XLNVTKCjbyobZEzMNGviiHkx7Vgqx6+BRJqg1uNFGOYmZJrnf4ZTCaqpvykXUs+CZGw3YC7VvWvUKiyzv5fmqE3A8I="
    # DOCKER_USERNAME for our DockerHub account
    - secure: "SeClVCFBXKAhynv5wD/6OdqLwtK0d5kc0XawlwinPBT2Hg5Y1ZlQKIAZsOwOqXTUcAQtVjnHYLru09ataLuDRIdtcZeDv7TKkE6ZS9nFb4bMM8j6XwxFo2lM4pICks7tY5clClRTvTzdxbkPbmfxHnInHnZmB8md/gOIi3KJseRVS9aignr+1qxyvuyAPha9Rxeiz+iOo4kWKuK3IGiSKp5qIJczoz631f3lsZQJ14Eyiz8vcCL0mJxQ3RbBfl9pNsYmM9XZSCSp9yRNCCDkLGUZNIRNjamy5UFxkhb2meGWOCTAgD5kvRl5LjIv7i2//r46tBN9OMZ8Agz4FvVM9OzWMGCGoimQ6omTp+/+bn+gBhssVoZi4Z9EgYdl2oWPCk8XihmCpFcY/wWrxuYWjQ9u5eXOEVrLp3qNMhmq1X3Z/RWev40b1hWy5ofqjdKfQHsC6j/HHGzxey+VRR9PZHke9c38uOLqb/4Wkaa5Nm3W4cFaeAzyB26GjTe2FiaKZKmYyHz75G52TEoFAOoe2UShp/JDG/HAefr2XJuA1vxHfn/xURMxvoHJ3XEfOORE1S+mP3iREl3Gl1hlp9Dpa6UTWkO6WWdMkBhhX104zyHtTtJu1EebAgoUzoyTe14gi8OgD6FECGyUK4f4c9PlfKabu0y72Nw29t5ef4OKffc="
    # DOCKER_PASSWORD for our DockerHub account
    - secure: "DvQvxpRtfC/EUZ8LjxjL7XvfRRHmt1eimmSbDCAObedkglvjyI0Cvv0njzHDnPLLLZQ2HgtDAzVwZ4OhcJxw0L2olv8/3n01dTwgisziC/bquQHUJHB735naHJUUHB+Id0+02TB9VSJUSeWmlV6wml1hPgk290sHUNQ3+zLxYz51/F6pw4dC4hNuEji0J8A+wDsx2GUGPZaRqiVqAFjKGcnbRTZF/uZ/NRk5AVsxVW+4CF6Jy/e+9WNkj7XlPtPMSS8HCz+20hbhKRJTqlul2pMQOhqWBClEE39kKEd3Mv5UxeCr6hunAEVyS4ig91XgZykSh4/BZ5Tj9aG7LsA0uE4mAhYmN0NrfG3dtfSFSVPF9LwENk2hrh1HSLjuYF1VZpW+sJqnYZmZ35yBY+WtbUd2IwHZ/eVjKk4JX4O2+W3B62GuldSxwYGpoE0wJjmucGSt2XGo7r1nC1Em1rcA9wbzUPjb4Q6/MVPsrX0o3NKUcCn2FoOCat92Ge7WwnIM7LaHm0/6j2uoXLzPd8VAyxLLq0vhyY/7cxQp+8/+j7fIU4K0yJYNq97OOXlcSdkWhNW3kmnE26mPmWUQht5icz0YFAHielPLn3GarZA2X5bYeZ4ffElaN+QFv/4Jy4qRHS0Caml3el2Xi3jqQcj6DFRVKHNdNyvm0JL7b58xfv0="


before_install:
    - pip install --user awscli

stages:
- name: besd
  if:  branch = foo
- name: olfs
  if:  branch = foo
- name: hyrax
  if:  branch = master
- name: hyrax_ncwms
  if:  branch = foo

jobs:
  include:
    - stage: besd
      script: 
        - git status;
        - ls -l
        - cd hyrax-snapshot 
        - docker build --build-arg RELEASE_DATE=`date +%s` -t "opendap/besd:snapshot" besd
        - docker image ls -a
        - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin 
        - docker push opendap/besd:snapshot

    - stage: olfs
      script: 
        #- git checkout snapshot;
        - ls -l
        - cd hyrax-snapshot 
        - docker build --build-arg RELEASE_DATE=`date +%s` -t "opendap/olfs:snapshot" olfs
        - docker image ls -a
        - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin 
        - docker push opendap/olfs:snapshot

    - stage: hyrax
      script: 
        #- git checkout snapshot;
        - ls -l
        - cd hyrax-snapshot 
        - docker build --build-arg RELEASE_DATE=`date +%s` -t "opendap/hyrax:snapshot" hyrax
        - docker image ls -a
        - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin 
        - docker push opendap/hyrax:snapshot
        - echo "ID: AWS_ACCESS_KEY_ID"
        - echo "KEY: $AWS_SECRET_ACCESS_KEY"
        - export DOCKER_LOGIN=`aws ecr get-login --region us-east-1`
        - $DOCKER_LOGIN
        - docker tag opendap/hyrax:snapshot 747931985039.dkr.ecr.us-east-1.amazonaws.com/opendap/hyrax:snapshot
        - docker push 747931985039.dkr.ecr.us-east-1.amazonaws.com/opendap/hyrax:snapshot


    - stage: hyrax_ncwms
      script:
        #- git checkout snapshot;
        - ls -l
        - cd hyrax-snapshot
        - docker build --build-arg RELEASE_DATE=`date +%s` --build-arg USE_NCWMS=true -t "opendap/hyrax_ncwms:snapshot" hyrax
        - docker image ls -a
        - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
        - docker push opendap/hyrax_ncwms:snapshot


